{"version":3,"sources":["../../src/datasource.js"],"names":["_","Util","CmsSigner","Describer","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","basePath","url","name","jsonData","q","util","headers","cmsVersion","ecsVersion","ecsBasePath","rdsVersion","rdsBasePath","options","requests","result","targets","forEach","target","project","metric","ycol","xcol","describe","exists","resolve","period","group","dimensions","dimensions_varabiles","dimension","push","ycol_varabiles","y_col","indexOf","length","dimensionAcsJson","dimensionAcsObj","toString","replace","JSON","stringify","i","includes","dimension_i","queryConcat","parseInt","range","from","_d","getTime","to","param","path","method","query","buildRealUrl","isEmpty","d","defer","data","promise","request","datasourceRequest","then","response","status","Code","_transformQueryResponse","concat","res","parse","catch","error","console","log","Promise","all","map","p","e","resResult","dataDatapoints","angular","fromJson","Datapoints","target_datapoints","instanceDescs","instanceIds","uniq","describer","proxy","credentials","access_key","atob","cmsAccessKey","secret_key","cmsSecretKey","instanceId","arr","dims","decodeURIComponent","dim","description","datapoints","ycolTarget","datapoint","point","ErrorCode","Success","message","title","namespacesQuery","match","filter","templateToStr","getProject","namespaces","namespace","text","metricsQuery","getMetrics","metrics","tagFilterQuery","regionId","tagType","tagKey","nextToken","tagsFilter","toUpperCase","arrayToMap","tagsList","dimensionsQuery","instanceId_array","strToArray","filter_array","getDimensions","is_instanceId_bool","is_filter_bool","instanceId_result","tagQuery","resourceId","resourceId_array","tag","tag_array","listTagResources","Resources","Resource","resource","Project","acs_param","UserId","Metric","Periods","split","statistics","Statistics","groupInfo","groupId","GroupId","groupName","GroupName","value","endTime","Date","startTime","data_meta","response_meta","Dimensions","datapointInfo","index","reqUrl","realUrl","buildECSRealUrl","tags","Tags","Tag","TagKey","TagValue","buildRDSRealUrl","Items","TagInfos","resourceType","v","tag_key_array","tag_value_array","t","t_split","key","tagList","distinct_result","rep","tagResource","TagResources","TagResource","ResourceId","NextToken","nextList","signer","accessKeyId","base64_decode","secretAccessKey","version","addAuthorization","obj","re","RegExp","test"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\nimport {Util} from './util.js';\nimport {CmsSigner} from \"./signer.js\";\nimport Describer from \"./describer\";\n\nexport class GenericDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.basePath = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.jsonData = instanceSettings.jsonData;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.util = new Util(templateSrv);\n    this.headers = {'Content-Type': 'application/json'};\n    this.cmsVersion = \"2018-03-08\";\n    this.ecsVersion = \"2014-05-26\";\n    this.ecsBasePath = \"https://ecs.aliyuncs.com\";\n    this.rdsVersion = \"2014-08-15\";\n    this.rdsBasePath = \"https://rds.aliyuncs.com\";\n  }\n\n  query(options){\n    var requests = []\n    var result =[];\n    options.targets.forEach(target => {\n        //非空参数判空处理\n        if(!target.project || !target.metric || !target.ycol || !target.xcol){\n          return;\n        }\n        //默认数据\n        var ycol = target.ycol;\n        var xcol = target.xcol;\n        var describe = !target.describe ? target.describe : target.describe +\".\";\n        //处理模版\n        var project = this.util.exists(target.project) ? this.util.resolve(target.project, {}):target.project;\n        var metric = this.util.exists(target.metric) ? this.util.resolve(target.metric, {}):target.metric;\n        var period = this.util.exists(target.period) ? this.util.resolve(target.period, {}):target.period;\n        var group = this.util.exists(target.group) ? this.util.resolve(target.group, {}):target.group;\n        //处理数组模版\n        var dimensions = \"\";\n        var dimensions_varabiles = [];\n        \n        target.dimensions.forEach(dimension => {\n            this.util.exists(dimension) ? dimensions_varabiles.push(this.util.resolve(dimension, {})) : dimensions_varabiles.push(dimension)\n        });\n        var ycol_varabiles = [];\n        ycol.forEach(y_col => {\n          y_col.indexOf(\"$\") != -1 ? ycol_varabiles.push(this.util.resolve(y_col, {})) : ycol_varabiles.push(y_col)\n        });\n        ycol = ycol_varabiles.length > 0 ? ycol_varabiles : ycol;\n        \n        //自定义监控(acs_custom)、日志监控(acs_logMonitor)处理,只取下标为0的数据\n        if(project.indexOf(\"acs_custom\") != -1 || project.indexOf(\"acs_logMonitor\") != -1){\n          var dimensionAcsJson = target.dimensions[0];\n          var dimensionAcsObj = {\"groupId\":group.toString(),\n                          \"dimension\":dimensionAcsJson.replace(/\\&/gi, '%26').replace(/\\{/gi, '%7B').replace(/\\}/gi, '%7D')};\n          dimensions = JSON.stringify(dimensionAcsObj);\n        }else{\n          //正常数据\n          dimensions = \"\"\n          dimensions_varabiles.forEach((dimension,i) =>{\n            if(typeof dimension == \"string\"){\n              dimension = dimension.includes(\"{\") ? dimension :  \"{\" + dimension;\n              dimension = dimension.includes(\"}\") ? dimension : dimension + \"}\";\n\n              dimensions += dimension;\n              if(i != dimensions_varabiles.length - 1){\n                dimensions += \",\"\n              }\n            }else{\n              dimension.forEach(dimension_i =>{\n                dimension_i = dimension_i.includes(\"{\") ? dimension_i : \"{\" + dimension_i;\n                dimension_i = dimension_i.includes(\"}\") ? dimension_i : dimension_i + \"}\";\n\n                dimensions += dimension_i;\n                if(i != dimensions_varabiles.length - 1){\n                  dimensions += \",\"\n                }\n              })\n            }\n          })\n          dimensions = \"[\" + dimensions + \"]\"\n          dimensions = dimensions.replace(/\\&/gi, '%26').replace(/\\{/gi, '%7B').replace(/\\}/gi, '%7D');\n        }\n        //拼接url参数\n        var queryConcat = \"/?Action=QueryMetricList&Length=90000&Project=\" + project + \"&Metric=\" + metric + \"&Period=\" + period + \n                        \"&Dimensions=\" + dimensions + \"&StartTime=\" + (parseInt(options.range.from._d.getTime())) +\n                        \"&EndTime=\" + (parseInt(options.range.to._d.getTime()));\n        var param = {\n            path: queryConcat,\n            method: \"GET\"\n        };\n        // 签名已拼接的待查询URL\n        var query = this.buildRealUrl(param);\n        if (_.isEmpty(query)) {\n            var d = this.q.defer();\n            d.resolve({data: []});\n            return d.promise;\n        } \n        //定义Promise元数据、根据URL发起请求\n        var request = this.backendSrv.datasourceRequest({\n          url: query,\n          method: 'GET',\n          headers: this.headers\n        }).then(response => {\n          if(response.status == '200' && response.data.Code == '200'){\n            return this._transformQueryResponse(response, xcol, ycol, dimensions, describe).then(res => {\n              result = result.concat(typeof res == 'string' ? JSON.parse(res) : res);\n            })\n          }\n        }).catch(function (error) {\n          console.log(error);\n        });\n        requests.push(request);\n      })\n\n    // 统一单独处理返回值\n    return Promise.all(requests.map(p => p.catch(e => e))).then(() => { return {data: result}; });\n  } \n\n  async _transformQueryResponse(response, xcol, ycol, dimensions, describe) {\n    let resResult = [];\n    let dataDatapoints = angular.fromJson(response.data.Datapoints);\n    //处理数据分类\n    let target_datapoints = [];\n    let instanceDescs = []\n\n    if (dimensions.includes(\"instanceId\")) {\n      let instanceIds = _.uniq(_.map(dataDatapoints, 'instanceId'))\n      let describer = new Describer({\n        proxy: this.backendSrv,\n        credentials: {\n          access_key: atob(this.jsonData.cmsAccessKey),\n          secret_key: atob(this.jsonData.cmsSecretKey)\n        }\n      })\n\n      try {\n        instanceDescs = await describer.describe(instanceIds)\n      } catch (e) {\n        console.error('Failed loading instance descriptions')\n      }\n\n      for (var i in dataDatapoints) {\n        if (!target_datapoints[dataDatapoints[i].instanceId]) {\n          var arr = [];\n          arr.push(dataDatapoints[i]);\n          target_datapoints[dataDatapoints[i].instanceId] = arr;\n        } else {\n          target_datapoints[dataDatapoints[i].instanceId].push(dataDatapoints[i]);\n        }\n      }\n    }\n\n    // 处理Grafana所需的target值、Target组的所需返回结果集\n    ycol.map(ycolTarget => {\n      if (dimensions.includes(\"instanceId\")) {\n        let dims = JSON.parse(decodeURIComponent(dimensions).replace(/;/g, ','))\n        for (let dim of dims) {\n          let target = null\n          if (instanceDescs[dim.instanceId]) {\n            target = instanceDescs[dim.instanceId].description\n          } else {\n            target = describe\n            if (target) {\n              target = target.replace(/\\.$/, '')\n            } else {\n              target = dim.instanceId\n            }\n          }\n\n          resResult.push({\n            target: target,\n            datapoints: target_datapoints[dim.instanceId].map(p => {\n              return [ p[ycolTarget], p[xcol] ]\n            })\n          })\n        }\n      } else {\n        var datapoints = [];\n        dataDatapoints.forEach(point => {\n          var datapoint = [];\n          datapoint.push(point[ycolTarget], point[xcol]);\n          // 封装返回目标的第二层数组值\n          datapoints.push(datapoint);\n        })\n        // 封装返回目标的第三层数组值\n        resResult.push({\n          \"target\": describe + ycolTarget,\n          \"datapoints\": datapoints\n        });\n      }\n    });\n\n    return resResult\n  }\n\n  // 测试连接数据源接口\n  testDatasource() {\n      var param = {\n          path: \"/?Action=AccessKeyGet\",\n          method: \"GET\"\n      };\n      return this.backendSrv.datasourceRequest({\n          url: this.buildRealUrl(param),\n          method: 'GET'\n      }).then(response => {\n          var data = response.data;\n          if (data.ErrorCode == 200 && data.Success == true ) {\n              return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n          }\n      });\n  }\n\n  annotationQuery(options){\n\n  } \n\n  metricFindQuery(options){\n      var result = []\n      //接受一个参数\n      var namespacesQuery = options.match(/^namespaces\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/);\n      namespacesQuery = namespacesQuery == null ? options.match(/^namespace\\(([^\\)]+?)(,\\s?([^,]+?))?\\)/) : namespacesQuery;\n      if(namespacesQuery != null){\n        var filter = this.util.templateToStr(namespacesQuery[1]);\n        return this.getProject().then(namespaces => {\n          result = namespaces\n          if(!this.isEmpty(filter)){\n            result = []\n            namespaces.map(namespace =>{\n              if(namespace.text.includes(filter)){\n                result.push(namespace)\n              }\n            })\n          }\n          return result;\n        })\n      }\n      \n      //接受二个参数\n      var metricsQuery = options.match(/^metrics\\(([^,]+?),\\s?([^,]+?)\\)/);\n      metricsQuery = metricsQuery == null ? options.match(/^metric\\(([^,]+?),\\s?([^,]+?)\\)/) : metricsQuery;\n      if(metricsQuery != null){\n        var namespace = this.util.templateToStr(metricsQuery[1]);\n        var filter = this.util.templateToStr(metricsQuery[2]);\n\n        result = []\n        return this.getMetrics(namespace).then(metrics => {\n          result = metrics\n          if(!this.isEmpty(filter)){\n            result = []\n            metrics.map(metric =>{\n              if(metric.text.includes(filter)){\n                result.push(metric)\n              }\n            })\n          }\n          return result;\n        })\n      }\n\n      //接受四个参数，过滤Tag提供key、value选择\n      var tagFilterQuery = options.match(/^tagFilter\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n      tagFilterQuery = tagFilterQuery == null ? options.match(/^tagsFilter\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : tagFilterQuery;\n      if(tagFilterQuery != null){\n        var type = this.util.templateToStr(tagFilterQuery[1]);\n        var regionId = this.util.templateToStr(tagFilterQuery[2]);\n        var tagType = this.isEmpty(tagFilterQuery[3]) ? \"\" : tagFilterQuery[3];\n        var tagKey = this.isEmpty(tagFilterQuery[4]) ? \"\" : tagFilterQuery[4];\n        var path = \"/?Action=DescribeTags&RegionId=\"+regionId;\n        var nextToken = \"\";\n        result = [];\n        return this.tagsFilter(type.toUpperCase(), nextToken, path, tagType, tagKey).then(tagsList => {\n          return this.util.arrayToMap(tagsList);\n        })\n      }\n\n      //接受四个参数,暂不支持数组，提供dimensions选择\n      var dimensionsQuery = options.match(/^dimension\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n      dimensionsQuery = dimensionsQuery == null ? options.match(/^dimensions\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : dimensionsQuery;\n      if(dimensionsQuery != null){\n        var namespace = this.util.templateToStr(dimensionsQuery[1]);\n        var metric =this.util.templateToStr(dimensionsQuery[2]);\n\n        var instanceId = dimensionsQuery[3]\n        var instanceId_array = this.util.exists(instanceId) ? this.util.resolve(instanceId, {}):[];\n        if(instanceId_array.length == 0){\n          if(this.isEmpty(instanceId)){\n            instanceId_array = [];\n          }else{\n            instanceId_array = this.util.strToArray(instanceId);\n          }\n        }\n        var filter = dimensionsQuery[4]\n        var filter_array = this.util.exists(filter) ? this.util.resolve(filter, {}):[];\n        if(filter_array.length == 0){\n          if(this.isEmpty(filter)){\n            filter_array = [];\n          }else{\n            filter_array = this.util.strToArray(filter);\n          }\n        }\n        result = []\n        return this.getDimensions(namespace, metric, \"\", []).then(dimensions => {\n          var is_instanceId_bool = this.isEmpty(instanceId);\n          var is_filter_bool = this.isEmpty(filter);\n          if(is_instanceId_bool){\n            result = dimensions;\n          }else{\n            var instanceId_result = [];\n            dimensions.map(dimension => {\n              instanceId_array.forEach(i => {\n                if(dimension.text.includes(i)){\n                  instanceId_result.push(dimension);\n                }\n              })\n            })\n            if(is_filter_bool){\n              result = instanceId_result\n            }else{\n              instanceId_result.map(dimension =>{\n                filter_array.forEach( i => {\n                  if(dimension.text.includes(i)){\n                    result.push(dimension)\n                  }\n                })\n              })\n            }\n          }\n          return result;\n        })\n      }\n\n      //接受5个参数,暂不支持数组，提供tag选择\n      var tagQuery = options.match(/^tag\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/);\n      tagQuery = tagQuery == null ? options.match(/^tags\\(([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?),\\s?([^,]+?)(,\\s?(.+))?\\)/) : tagQuery;\n      if(tagQuery != null){\n        var resourceId = tagQuery[4];\n        var resourceId_array = this.util.exists(resourceId) ? this.util.resolve(resourceId, {}):[];\n        if(resourceId_array.length == 0){\n          if(this.isEmpty(resourceId)){\n            resourceId_array = [];\n          }else{\n            resourceId_array = [];\n            resourceId_array = this.util.strToArray(resourceId);\n          }\n        }\n        var tag = tagQuery[5];\n        var tag_array = this.util.exists(tag) ? this.util.resolve(tag, {}):[];\n        if(tag_array.length == 0){\n          if(this.isEmpty(tag)){\n            tag_array = [];\n          }else{\n            tag_array = [];\n            tag_array = this.util.strToArray(tag);\n          }\n        }\n        return this.listTagResources(tagQuery[1].toUpperCase(), tagQuery[2], tagQuery[3], resourceId_array, tag_array);\n      }\n      return []\n  }\n\n  //返回所有的Project,QueryProjectMeta的API无自定义监控project、日志监控project，已拼接\n  getProject(){\n    var param = {\n        path: \"/?Action=QueryProjectMeta&PageNumber=1&PageSize=1000\",\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var result =[];\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          data.Resources.Resource.map(resource =>{\n            if(!this.isEmpty(resource.Project)){\n              result.push(resource.Project);\n            }\n          })\n        }\n        //增加自定义监控、日志监控选项\n        var acs_param = {\n            path: \"/?Action=AccessKeyGet\",\n            method: \"GET\"\n        };\n        return this.backendSrv.datasourceRequest({\n          url: this.buildRealUrl(acs_param),\n          method: 'GET'\n        }).then(response => {\n          var data = response.data;\n          if (data.ErrorCode == 200 && data.Success == true ) {\n              result.push(\"acs_logMonitor_\" + data.UserId);\n              result.push(\"acs_customMetric_\" + data.UserId);\n          }\n          return this.util.arrayToMap(result);\n        });\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //根据Project返回对应的所有的Metrics,无自定义监控、日志监控project对应的Metrics\n  getMetrics(project){\n    var param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1000&Project=\" + project,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var result =[];\n          data.Resources.Resource.map(resource =>{\n            if(!this.isEmpty(resource.Metric)){\n              result.push(resource.Metric);\n            }\n          })\n          return this.util.arrayToMap(result);\n        }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //根据Project及Metrics返回对应的所有的Period,无自定义监控、日志监控project对应的Period\n  getPeriod(project,metric){\n    var param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\"+ project + \"&Metric=\" + metric,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var period = [];\n          var resource = data.Resources.Resource;\n          if(resource.length > 0 && !this.isEmpty(resource[0].Periods)){\n            period =resource[0].Periods.split(\",\");\n          }\n          return this.util.arrayToMap(period);\n        }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //根据Project及Metrics返回对应的所有的Statistics,未去除已选项,无自定义监控、日志监控project对应的Period\n  getStatistics(project,metric){\n    var param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n        var data = response.data;\n        if (data.ErrorCode == 200 && data.Success == true) {\n          var statistics=[];\n          var resource = data.Resources.Resource;\n          if(resource.length > 0 && !this.isEmpty(resource[0].Statistics)){\n            statistics = resource[0].Statistics.split(\",\");\n          }\n          return this.util.arrayToMap(statistics);\n        }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  //返回所有的Groups,自定义监控、日志使用\n  getGroups(){\n    var param = {\n        path: \"/?Action=ListMyGroups&PageNumber=1&PageSize=9000\",\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n      var data = response.data;\n      if (data.ErrorCode == 200 && data.Success == true) {\n        var result =[];\n        var resource = data.Resources.Resource;\n        var i = resource.length;\n        while (i--) {\n            var group = resource[i];\n            var groupInfo =[];\n            var groupId = group.GroupId;\n            var groupName = group.GroupName;\n            if(this.isEmpty(groupId) || this.isEmpty(groupName)){\n               continue;\n            }\n            groupInfo.push(groupId,groupName + \" / \" + groupId);\n            result.push(groupInfo);\n        }\n        return _.map(result, (d, i) => {\n          return { text: d[1], value: d[0]};\n        });\n      }\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  getDimensions(project,metric,period,dimensions){\n    if(project.indexOf(\"acs_customMetric\") != -1 || project.indexOf(\"acs_logMonitor\") != -1){\n      return;\n    }\n    var result =[];\n    var endTime = new Date().getTime();\n    var startTime = endTime - 1 * 60 * 60 * 1000;\n    var param = {\n        path: \"/?Action=QueryMetricLast&Page=1&Length=90000&Period=\"+period+\"&Project=\" \n              + project + \"&Metric=\" + metric + \"&StartTime=\" + startTime + \"&EndTime=\" + endTime,\n        method: \"GET\"\n    };\n    return this.backendSrv.datasourceRequest({\n        url: this.buildRealUrl(param),\n        method: 'GET'\n    }).then(response => {\n      var data = response.data;\n      if(data.Success == false){\n          return;\n      }\n      // 构建可选参数dimensions\n      param = {\n        path: \"/?Action=QueryMetricMeta&PageNumber=1&PageSize=1&Project=\" + project + \"&Metric=\" + metric,\n        method: \"GET\"\n      };\n      return this.backendSrv.datasourceRequest({\n          url: this.buildRealUrl(param),\n          method: 'GET'\n      }).then(response_meta => {\n          var data_meta = response_meta.data;\n          if (data_meta.ErrorCode == 200 && data_meta.Success == true) {\n            var resource = data_meta.Resources.Resource;\n            if(resource.length == 0 || this.isEmpty(resource[0].Dimensions)){\n              return;\n            }\n            var dimension = resource[0].Dimensions.split(\",\");\n            var datapoints = JSON.parse(data.Datapoints);\n            datapoints.map(datapoint =>{\n              var datapointInfo = \"{\\\"\";\n              dimension.forEach(function(value,index){\n                value = value.replace(/\"/g,\"\");\n                if(value != \"userId\"){\n                  datapointInfo += value +\"\\\":\\\"\"+datapoint[value] +\"\\\"\";\n                  if(index == dimension.length - 1){\n                    datapointInfo +=\"}\";\n                  }else{\n                    datapointInfo +=\";\\\"\";\n                  }\n                }\n              });\n              //去重\n              if(result.length == 0){\n                if(dimensions.length == 0){\n                  result.push(datapointInfo);\n                }else if(dimensions.length > 0 && !dimensions.includes(datapointInfo)){\n                  result.push(datapointInfo);\n                }\n              }else if(result.length > 0 && !result.includes(datapointInfo)){\n                if(dimensions.length == 0){\n                  result.push(datapointInfo);\n                }else if(dimensions.length > 0 && !dimensions.includes(datapointInfo)){\n                  result.push(datapointInfo);\n                }\n              }\n            })\n            return this.util.arrayToMap(result);\n        }\n      });\n    }).catch(function (error) {\n      console.log(error);\n      return;\n    });\n  }\n\n  // 暂时无翻页功能,无nextToken字段返回\n  tagsFilter(type, nextToken, path, tagType, tagKey) {\n    var reqUrl = path;\n    if(!this.isEmpty(nextToken)){\n      reqUrl += \"&NextToken=\" + nextToken;\n    }\n    var param = {\n      path: reqUrl,\n      method: \"GET\"\n    };\n    var realUrl = \"\";\n    if(\"ECS\" == type){\n      realUrl = this.buildECSRealUrl(param);\n      return this.backendSrv.datasourceRequest({\n        url: realUrl,\n        method: 'GET'\n      }).then(response => {\n        var result =[];\n        var data = response.data;\n        var tags = data.Tags.Tag;\n        if(tags.length > 0){\n          tags.forEach(tag => {\n            if(\"key\" == tagType){\n              if(!result.includes(tag.TagKey)){\n                result.push(tag.TagKey);\n              }\n            }else if(\"value\" == tagType){\n              if(tag.TagKey == tagKey || tagKey == \"\"){\n                var value = tag.TagKey + \":/:\" + tag.TagValue\n                if(!result.includes(value)){\n                  result.push(value);\n                }\n              }\n            }\n          });\n        }\n        return result;\n      })\n    }else if(\"RDS\" == type){\n      realUrl = this.buildRDSRealUrl(param);\n      return this.backendSrv.datasourceRequest({\n        url: realUrl,\n        method: 'GET'\n      }).then(response => {\n        var result =[];\n        var data = response.data;\n        var tags = data.Items.TagInfos;\n        if(tags.length > 0){\n          tags.forEach(tag => {\n            if(\"key\" == tagType){\n              if(!result.includes(tag.TagKey)){\n                result.push(tag.TagKey);\n              }\n            }else if(\"value\" == tagType){\n              if(tag.TagKey == tagKey || tagKey == \"\"){\n                var value = tag.TagKey + \":/:\" + tag.TagValue\n                if(!result.includes(value)){\n                  result.push(value);\n                }\n              }\n            }\n          });\n        }\n        return result;\n      })\n    }\n  }\n\n  listTagResources(type, regionId, resourceType, resourceId, tag){\n    type = this.isEmpty(type) ? \"ECS\" : type;\n    regionId = this.isEmpty(regionId) ? \"cn-hangzhou\" : regionId;\n    if(\"ECS\" == type){\n      resourceType = this.isEmpty(resourceType) ? \"instance\" : resourceType;\n    }else if(\"RDS\" == type){\n      resourceType = this.isEmpty(resourceType) ? \"INSTANCE\" : resourceType;\n    }\n    var path = \"/?Action=ListTagResources&RegionId=\"+regionId+\"&ResourceType=\" + resourceType;\n    for(var i = 0; i < resourceId.length; i++){\n      if(50 > i){\n        var v = resourceId[i];\n        if(!this.isEmpty(v)){\n          path += \"&ResourceId.\" + (parseInt(i) + 1).toString() + \"=\" + v;\n        }\n      }\n    }\n    var tag_key_array = [];\n    var tag_value_array = [];\n    tag.forEach(t =>{\n      if(!this.isEmpty(t)){\n        if(t.indexOf(\":/:\") != -1){\n          var t_split = t.split(\":/:\");\n          if(!tag_key_array.includes(t_split[0])){\n            tag_key_array.push(t_split[0]);  \n          }\n          if(!tag_value_array.includes(t_split[1])){\n            tag_value_array.push(t_split[1]);\n          }\n        }\n      }\n    });\n    if(tag_key_array.length > 0){\n      for(var i = 0; i < tag_key_array.length; i++){\n        var key = tag_key_array[i];\n        path += \"&Tag.\" + (parseInt(i) + 1).toString() + \".Key=\" + key;\n      }\n    }else if(tag_key_array.length == 0 && tag.length > 0){\n      for(var i = 0; i < tag.length; i++){\n        var key = tag[i];\n        path += \"&Tag.\" + (parseInt(i) + 1).toString() + \".Key=\" + key;\n      }\n    }\n    var nextToken = \"\";\n    return this.tagList(type, nextToken, path, tag_value_array).then(rep =>{\n      var distinct_result = []\n      rep.forEach(instanceId =>{\n        if(!distinct_result.includes(instanceId)){\n          distinct_result.push(instanceId);\n        }\n      })\n      return this.util.arrayToMap(distinct_result);\n    });\n  }\n  // 处理nextToken问题\n  tagList(type, nextToken, path, tag_value_array) {\n    var reqUrl = path;\n    if(!this.isEmpty(nextToken)){\n      reqUrl += \"&NextToken=\" + nextToken;\n    }\n    var param = {\n      path: reqUrl,\n      method: \"GET\"\n    };\n    var realUrl = \"\";\n    if(\"ECS\" == type){\n      realUrl = this.buildECSRealUrl(param);\n    }else if(\"RDS\" == type){\n      realUrl = this.buildRDSRealUrl(param);\n    }\n    return this.backendSrv.datasourceRequest({\n      url: realUrl,\n      method: 'GET'\n    }).then(response => {\n      var result =[];\n      var data = response.data;\n      var tagResource = data.TagResources.TagResource;\n      if(tagResource.length > 0){\n        tagResource.forEach(resource => {\n          if(tag_value_array.length > 0){\n            if(tag_value_array.includes(resource.TagValue)){\n              result.push(resource.ResourceId);\n            }\n          }else {\n            result.push(resource.ResourceId);\n          }\n        })\n      };\n      if(this.isEmpty(data.NextToken)){\n        return result;\n      }else{\n        return this.tagList(type, data.NextToken, path, tag_value_array).then(nextList =>{\n          return result.concat(nextList);\n        });\n      }\n    })\n  }\n\n  // 根据云监控API文档处理URL签名,做封装调用接口用\n  buildRealUrl(param) {\n    var signer = new CmsSigner({\n        accessKeyId: this.util.base64_decode(this.jsonData.cmsAccessKey),\n        secretAccessKey: this.util.base64_decode(this.jsonData.cmsSecretKey),\n        version: this.cmsVersion\n    }, param);\n    signer.addAuthorization();\n    return this.basePath + signer.request.path;\n  }\n\n  // 根据ECS API文档处理URL签名,做封装调用接口用\n  buildECSRealUrl(param){\n    var signer = new CmsSigner({\n        accessKeyId: this.util.base64_decode(this.jsonData.cmsAccessKey),\n        secretAccessKey: this.util.base64_decode(this.jsonData.cmsSecretKey),\n        version: this.ecsVersion\n    }, param);\n    signer.addAuthorization();\n    return this.ecsBasePath + signer.request.path;\n  }\n\n  // 根据RDS API文档处理URL签名,做封装调用接口用\n  buildRDSRealUrl (param){\n    var signer = new CmsSigner({\n        accessKeyId: this.util.base64_decode(this.jsonData.cmsAccessKey),\n        secretAccessKey: this.util.base64_decode(this.jsonData.cmsSecretKey),\n        version: this.rdsVersion\n    }, param);\n    signer.addAuthorization();\n    return this.rdsBasePath + signer.request.path;\n  }\n  \n  // 判断对象是否为空对象 true 空 \n  isEmpty(obj) { \n    var re = new RegExp(\"^[ ]+$\");\n    if(!obj || obj == \"null\" || obj == null || obj == \" \" || obj == \"\" \n      || obj == '\"\"' || re.test(obj) || typeof(obj) == \"undefined\"){\n      return true\n    }// 为空\n    return false; // 不为空\n  }\n}"]}